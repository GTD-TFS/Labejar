<!doctype html>
<html lang="es">
<head>
  <link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b1220">

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LABEJAR">

<link rel="apple-touch-icon" href="./abeja.png">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LABEJARüêù</title>
<style>
  :root{
    /* iOS-like dark palette */
    --bg: #071a2a;
    --surface: rgba(255,255,255,.045);
    --surface-2: rgba(255,255,255,.085);
    --border: rgba(255,255,255,.10);
    --text: rgba(255,255,255,.92);
    --muted: rgba(255,255,255,.62);
    --hairline: rgba(255,255,255,.08);

    --blue: #0A84FF;     /* iOS system blue */
    --green: #34C759;    /* iOS system green */
    --red: #FF453A;      /* iOS system red */
    --orange: #FF9F0A;   /* iOS system orange */
    --gold: #d6b36a;    /* warm gold accent */

    --radius: 16px;
    --radius-sm: 12px;
    --shadow: 0 12px 30px rgba(0,0,0,.38);
  }

  *{ box-sizing:border-box; }
  html,body{ min-height:100%; }
  html{ background: var(--bg); }

  body{
    margin:0;
    padding: 70px 16px 16px;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    color:var(--text);
    background:none;
    min-height:100dvh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  body::before{
    content:"";
    position:fixed;
    inset:0;
    z-index:-1;
    background:
      radial-gradient(1100px 700px at 20% -10%, rgba(26,120,200,.34), transparent 62%),
      radial-gradient(900px 650px at 85% 0%, rgba(214,179,106,.16), transparent 60%),
      radial-gradient(900px 700px at 60% 110%, rgba(6,18,32,.55), transparent 60%),
      linear-gradient(180deg, #061a2b, #04101d);
  }

  /* App layout */
  .app{
    max-width: 980px;
    margin: 0 auto;
    display: grid;
    gap: 14px;
  }

  /* Capsule header */
  .topbar.fixed{
    position: fixed;
    top: calc(env(safe-area-inset-top, 0px) + 12px);
    right: calc(env(safe-area-inset-right, 0px) + 12px);
    left: auto;
    z-index: 1000;
    width: auto;
    margin: 0;
    padding: 10px;
    border-radius: 9999px;
    background: transparent;
    border: 0;
    box-shadow: none;
    backdrop-filter: none;
    pointer-events: auto;
  }

  .brandTitle{
    margin: 0;
    font-size: 40px;
    font-weight: 800;
    letter-spacing: .4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--text);
    cursor: pointer;
    user-select: none;
    line-height: 1;
    height: 38px;
    width: 38px;
    line-height: 38px;
    transform: translateX(-1px);
    animation: beeFloat 4.2s infinite ease-in-out;
    will-change: transform;
  }

  @keyframes beeFloat{
    0%   { transform: translateX(-1px) translateY(0px) rotate(0deg); }
    12%  { transform: translateX(-3px) translateY(-2px) rotate(-2deg); }
    28%  { transform: translateX(1px)  translateY(-3px) rotate(2deg); }
    46%  { transform: translateX(-2px) translateY(1px) rotate(-1deg); }
    63%  { transform: translateX(2px)  translateY(2px) rotate(1deg); }
    78%  { transform: translateX(-1px) translateY(-1px) rotate(-2deg); }
    100% { transform: translateX(-1px) translateY(0px) rotate(0deg); }
  }

  @media (prefers-reduced-motion: reduce){
    .brandTitle{ animation: none !important; }
  }

  .subbar{
    display: flex;
    align-items: center;
justify-content: center;
    gap: 12px;
    padding: 10px 14px;
    margin-top: 10px;
    background: var(--surface);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: var(--radius);
    backdrop-filter: blur(14px);
  }

  .subtitle{
    font-size: 13px;
    color: rgba(214,179,106,.95);
    letter-spacing: .6px;
    white-space: nowrap;
    text-align: center;
    font-weight: 700;
    flex: 1;
  }

  /* Card */
  .card{
    background: var(--surface);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: var(--radius);
    padding: 14px;
    backdrop-filter: blur(14px);
    box-shadow: var(--shadow);
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Let the main card use most of the viewport height */
  /* Let the main card use most of the viewport height */
  .card{
    min-height: calc(100dvh - 120px);
    height: calc(100dvh - 120px);
  }

  /* Servicios: recortar la tarjeta por abajo para que el Logout quede fuera del contorno */
  body.inServicios .card{
    height: calc(100dvh - 120px - 86px);
    min-height: calc(100dvh - 120px - 86px);
    margin-bottom: 86px;
  }

  @media (max-width: 520px){
    body.inServicios .card{
      height: calc(100dvh - 120px - 96px);
      min-height: calc(100dvh - 120px - 96px);
      margin-bottom: 96px;
    }
  }

  /* Comparecencia: make textarea grow to fill remaining space */
  #screenComparecencia{
    display: flex;
    flex-direction: column;
    gap: 14px;
    height: 100%;
  }
  #screenComparecencia .span2{ width: 100%; }
  #screenComparecencia #Doc{
    flex: 1 1 auto;
    min-height: 240px;
    height: 100%;
    resize: none;
  }

  /* Form grid */
  .fields{ display:block; height: 100%; }

  #screenFiliacion,

  #screenServicios{
    display:grid;
    gap:22px;
    grid-template-columns: 1fr;
    padding-bottom: 20px;
  }
  #screenComparecencia .span2:has(#Doc){ flex:1 1 auto; display:flex; }
  #screenComparecencia .span2.row:has(#download){
    margin-top: auto;
  }
  @media(min-width:820px){
    #screenFiliacion,
    #screenServicios{
      grid-template-columns: 1fr 1fr;
    }
  }

  .span2{ grid-column: 1 / -1; }

  label{
    display:block;
    font-size: 12px;
    color: rgba(214,179,106,.88);
    margin: 0 0 8px;
  }

  /* Center alignment only for Filiaci√≥n form */
  #screenFiliacion label{ text-align: left; }
  #screenFiliacion input,
  #screenFiliacion select,
  #screenFiliacion textarea{
    text-align: center;
  }

  /* Keep select arrow usable: center text but leave room for the arrow */
  #screenFiliacion select{ text-align-last: center; }

  input, select, textarea{
    width:100%;
    padding: 12px 12px;
    border-radius: var(--radius-sm);
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    color: var(--text);
    outline: none;
    transition: border-color .15s ease, background .15s ease;
  }

  input, select{ height: 38px; }
  select{
  line-height: normal;
  padding-top: 8px;
  padding-bottom: 8px;
}
  textarea{ min-height: 140px; resize: vertical; }
  input:focus, select:focus, textarea:focus{ border-color: rgba(10,132,255,.65); }
@media (max-width: 520px){
  input, select, textarea{
    font-size: 16px;
  }
}
  select{
    -webkit-appearance: none;
    appearance: none;
    padding-right: 38px;
    line-height: 1.2;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3E%3Cpath fill='rgba(255,255,255,.55)' d='M5.25 7.5 10 12.25 14.75 7.5 16 8.75 10 14.75 4 8.75z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 18px 18px;
  }

  input.valid,select.valid{ border-color: rgba(52,199,89,.7) !important; }
  input.invalid,select.invalid{ border-color: rgba(255,69,58,.75) !important; }
  input.uncertain, select.uncertain, textarea.uncertain{ border-color: rgba(255,159,10,.75) !important; }

  /* Buttons */
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row.center{ justify-content:center; }

  .btn{
    appearance: none;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color: rgba(214,179,106,.92);
    padding: 10px 12px;
    border-radius: 9999px;
    cursor: pointer;
    font-weight: 650;
    letter-spacing: .2px;
    transition: transform .12s ease, background .15s ease, border-color .15s ease;
  }
  .btn:hover{ background: rgba(255,255,255,.09); }
  .btn:active{ transform: scale(.98); }
  .btn:focus{ outline: 2px solid rgba(10,132,255,.45); outline-offset: 2px; }

  .btn.secondary{
    background: transparent;
    border-color: rgba(255,255,255,.14);
    font-weight: 600;
    color: rgba(214,179,106,.86);
  }

  /* Auth buttons: keep neutral text (not gold) */
  #authRow .btn.secondary{
    color: var(--text);
  }

  #clearForm{ border-color: rgba(255,69,58,.65); }

  /* === Auth UI simplificado: solo IA On / IA Off === */
  #authBadge{
    display:none !important;
  }

  /* IA Off: fixed subtle inner glow (mobile-friendly) */
  #btnAuth{
    color: var(--text);
    border-color: rgba(255,69,58,.40);
    box-shadow: inset 0 0 0 1px rgba(255,69,58,.22),
                inset 0 10px 18px rgba(255,69,58,.10);
  }

  /* IA On: fixed subtle inner glow (mobile-friendly) */
  #btnLogout{
    color: var(--text);
    border-color: rgba(52,199,89,.40);
    box-shadow: inset 0 0 0 1px rgba(52,199,89,.22),
                inset 0 10px 18px rgba(52,199,89,.10);
  }

  #readAnalyzeFile{
    padding: 10px 12px;
    font-size: 18px;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .iconPng{
    width: 22px;
    height: 22px;
    display: block;
  }

  .svcGrid{
    display: grid;
    gap: 10px;
  }
  .svcRow{
    display: grid;
    grid-template-columns: 1fr 44px;
    grid-template-rows: auto auto;
    grid-template-areas:
      "time del"
      "txt  txt";
    gap: 10px;
    align-items: center;
  }

  .svcRow input[type="time"]{
    grid-area: time;
    justify-self: start;
    width: 96px;       /* iOS-safe width for 00:00 */
    min-width: 96px;
    max-width: 110px;
    padding-left: 12px;
    padding-right: 12px;
    font-variant-numeric: tabular-nums;
  }
  .svcRow .svcTxt{
    grid-area: txt;
    width: 100%;
    min-height: 38px;
    resize: none;
    overflow: hidden;
    line-height: 1.25;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .svcRow .svcDel{ grid-area: del; }

  .svcRow .svcDel{
    padding: 10px 0;
    width: 44px;
    text-align: center;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 6px 10px;
    border-radius: 9999px;
    border: 1px solid rgba(214,179,106,.16);
    background: rgba(255,255,255,.06);
    color: var(--muted);
    font-size: 12px;
    white-space: nowrap;
  }

  ul.list{ list-style:none; margin:0; padding:0; display:flex; flex-wrap:wrap; gap:8px; }
  ul.list li{
    display:flex;
    align-items:center;
    gap:8px;
    border-radius: 9999px;
    padding: 8px 10px;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.14);
    box-shadow:
  inset 0 0 0 1px rgba(10,132,255,.20),
  inset 0 10px 18px rgba(10,132,255,.09),
  inset 0 -10px 18px rgba(10,132,255,.05);
    font-size: 12px;
  }
  ul.list li button{ margin-left: 2px; }

  /* Modals */
  .modal{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    background: rgba(0,0,0,.58);
    z-index: 9999;
    padding: 16px;
  }
  .modal.open{ display:flex; }
  .modal .panel{
    width: min(520px, 96vw);
    background: rgba(20,24,30,.92);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: var(--radius);
    padding: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
    backdrop-filter: blur(16px);
  }
  .modal .panel h2{ margin:0 0 10px; font-size: 16px; color: var(--text); }
  .modal .panel .fields2{ display:grid; gap:10px; grid-template-columns: 1fr; }
  @media(min-width:520px){ .modal .panel .fields2{ grid-template-columns: 1fr 1fr; } }

  @media (max-width: 520px){
    body{
      padding: calc(12px + env(safe-area-inset-top))
               calc(12px + env(safe-area-inset-right))
               calc(12px + env(safe-area-inset-bottom))
               calc(12px + env(safe-area-inset-left));
    }
    .subbar{ flex-wrap: wrap; gap: 8px; }
    .subbar .subtitle{ flex: 1 1 100%; }
    .btn{ padding: 10px 11px; }
  }
  #toastCenter{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:100000;
padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.18);
background:rgba(10,16,26,.82);color:rgba(255,255,255,.92);font-weight:800;letter-spacing:.4px;
box-shadow:0 18px 55px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.16);
backdrop-filter:blur(14px);opacity:0;pointer-events:none;transition:opacity .12s ease}
#toastCenter.show{opacity:1}
/* === Lock: hide the whole app UI until authenticated === */
body.locked .card,
body.locked .subbar{ display:none !important; }

.lockScreen{
  display:none;
  align-items:center;
  justify-content:center;
  min-height: calc(100dvh - 120px);
}
body.locked .lockScreen{ display:flex; }

.lockPanel{
  width: min(520px, 94vw);
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(14px);
  text-align:center;
}
.lockTitle{
  font-weight: 850;
  letter-spacing: .3px;
  font-size: 16px;
  color: var(--text);
}
.lockHint{
  margin-top: 8px;
  font-size: 13px;
  color: var(--muted);
}
#lockErr{
  margin-top: 10px;
  color: rgba(255,159,10,.92);
  font-weight: 700;
  display:none;
}

/* Logout flotante (solo Servicios): fuera de contenedores scroll */
#btnLogoutServicios{
  position: fixed;
  right: calc(env(safe-area-inset-right, 0px) + 16px);
  bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
  z-index: 3000;
  display: none;
  pointer-events: auto;
}
body.fbAuthed.inServicios #btnLogoutServicios{ display: inline-flex; }
</style>
</head>
<body>
<!-- Logout solo en Servicios (fuera de contenedores) -->
<button id="btnLogoutServicios" class="btn secondary" title="Cerrar sesi√≥n">Logout</button>
<div class="app">
  <header class="topbar fixed" aria-label="Limpiar">
    <h1 class="brandTitle" id="btnClearFromHeader" data-title="FILIATRON" title="Limpiar formulario">üêù</h1>
  </header>

  <div class="subbar">
    <span class="subtitle" id="subtitleText">Filiaciones y Comparecencia GPT</span>
  </div>
  <!-- Lock screen: app UI hidden until Firebase session exists -->
<div id="lockScreen" class="lockScreen" aria-live="polite">
  <div class="lockPanel">
    <div class="lockTitle">Acceso requerido</div>
    <div class="lockHint">Inicia sesi√≥n para acceder</div>

    <div class="row center" id="authRow" style="margin:14px 0 0">
      <span class="badge" id="fbAuthBadge" title="Firebase Auth">Sin sesi√≥n</span>
      <button class="btn secondary" id="fbLoginBtn">Login</button>
      <button class="btn secondary" id="fbLogoutBtn" style="display:none">Logout</button>
    </div>

    <div class="lockHint" id="lockErr"></div>
  </div>
</div>
<div class="card">
<div class="fields">
<div id="screenFiliacion">
  

<!-- 2) CAMPOS FILIACI√ìN -->
<div><label>Condici√≥n</label>
<select id="Condicion">
  <option></option>
  <option>Perjudicado</option>
  <option>Testigo</option>
  <option>V√≠ctima</option>
  <option>Requirente</option>
  <option>Denunciado</option>
  <option>Identificado</option>
  <option>Infractor</option>
</select>
</div>
<div><label>Nombre</label><input id="Nombre"></div>
<div><label>Apellidos</label><input id="Apellidos"></div>
<div>
  <label>Tipo de documento</label>
  <select id="Tipo">
    <option></option>
    <option>DNI</option>
    <option>NIE</option>
    <option>PASAPORTE</option>
    <option>Indocumentado</option>
    <option>Carta Nacional de Identidad</option>
    <option>Otro Documento de Identidad</option>
  </select>
</div>
<div><label>N¬∫ documento</label><input id="Numero"></div>
<div><label>Sexo</label>
<select id="Sexo"><option></option><option>MASCULINO</option><option>FEMENINO</option></select>
</div>
<div>
  <label>Nacionalidad</label>
  <input id="Nacionalidad" list="dlNacionalidad" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off">
  <datalist id="dlNacionalidad"></datalist>
</div>
<div class="span2"><label>Nombre de los Padres</label><input id="Padres"></div>
<div>
  <label>Fecha de nacimiento</label>
  <input id="Nacimiento" type="text" inputmode="numeric" placeholder="dd/mm/aaaa" pattern="\d{2}/\d{2}/\d{4}" autocomplete="bday">
</div>
<div><label>Lugar de nacimiento</label><input id="Lugar"></div>
<div class="span2"><label>Domicilio</label><input id="Domicilio"></div>
<div><label>Tel√©fono</label><input id="Telefono" inputmode="numeric" pattern="[0-9 ]*"></div>

<!-- 3) LISTA / CONTADOR / AGREGAR -->
<div class="span2 row center" style="margin-top:8px">
  <button class="btn" id="addFiliacion">üë§ Agregar</button>
</div>
<div class="span2 row center" style="margin-top:6px">
  <ul class="list" id="listaF"></ul>
</div>
</div>

<div id="screenComparecencia" style="display:none">
  <div class="span2 row" style="margin-top:8px;justify-content:space-between">
<button class="btn" id="gptComparecencia" title="Abrir Denuncia">GPT</button>
    <button class="btn" id="integrarDoc" title="Pegar desde portapapeles">üìã</button>
  </div>

  <div class="span2">
    <textarea id="Doc" placeholder="Texto / comparecencia..."></textarea>
  </div>

  <div class="span2 row" style="justify-content:space-between">
  <button class="btn" id="download">üì• Descargar</button>
  <button class="btn" id="loadPlain">‚¨ÜÔ∏è Importar</button>
  <button class="btn" id="sendDenupolBtn">‚òÅÔ∏è Enviar a GTD</button>
</div>
  <!-- input oculto requerido por importar.js -->
  <input id="plainInput" type="file" accept=".json,.enc,application/json,text/plain" hidden>
</div>

<div id="screenServicios" style="display:none">
  <div class="span2 row" style="margin-top:8px;justify-content:space-between">
    <button class="btn" id="svcAdd">Ôºã A√±adir</button>
    <button class="btn secondary" id="svcClear" title="Borrado especial">üßπ Borrar servicios</button>
  </div>

  <div class="span2" style="margin-top:14px">
    <div id="svcGrid" class="svcGrid"></div>
  </div>

</div>
</div>
</div>
</div>
</div>
<script src="provincias_es.js"></script>
<script src="municipios.js"></script>
<script src="paises.js"></script>
<script src="calles.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="mrz.js"></script>
<script src="parser.js"></script>
<script src="comparecencia.js"></script>
<script src="servicios.js"></script>
<script src="crypto_json.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script>
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDUG_T31JEWDK9x_apUZVHwriWnjurNrms",
  authDomain: "denupol.firebaseapp.com",
  projectId: "denupol",
  appId: "1:691472437659:web:2cdd59082976841d7d513e"
};
const DENUPOL_COLLECTION="denupolInbox";
let FB={app:null,auth:null,db:null},__t=null;
function toastCenter(m){const el=document.getElementById('toastCenter'); if(!el)return; el.textContent=String(m||""); el.classList.add('show'); clearTimeout(__t); __t=setTimeout(()=>el.classList.remove('show'),1000);}
function initFirebase(){ try{ if(!FIREBASE_CONFIG.apiKey||!FIREBASE_CONFIG.projectId) return false;
FB.app=(firebase.apps&&firebase.apps.length)?firebase.app():firebase.initializeApp(FIREBASE_CONFIG);
FB.auth=firebase.auth(); FB.db=firebase.firestore(); return true; }catch(e){console.warn(e); return false;}}
function payload(){
  const exp = (window.expediente && typeof window.expediente==='object') ? window.expediente : (typeof expediente!=='undefined' ? expediente : null);
  return {
    doc: (document.getElementById('Doc')?.value || "") + "",
    filiaciones: (exp?.filiaciones || []),
    updatedAt: new Date().toISOString(),
    source: "Labejar"
  };
}
function ui(user){
  const badge = document.getElementById('fbAuthBadge');
  if (badge) badge.textContent = user ? (user.email || "Sesi√≥n") : "Sin sesi√≥n";

  const bIn  = document.getElementById('fbLoginBtn');
  const bOut = document.getElementById('fbLogoutBtn');
  const svcOut = document.getElementById('btnLogoutServicios');

  if (bIn)  bIn.style.display  = user ? 'none' : '';
  if (bOut) bOut.style.display = user ? '' : 'none';

  // clases de estado (controlan visibilidad del logout flotante)
  const s3 = document.getElementById('screenServicios');
  const inServicios = !!s3 && s3.style.display !== 'none';
  document.body.classList.toggle('fbAuthed', !!user);
  document.body.classList.toggle('inServicios', !!user && inServicios);

  document.body.classList.toggle('locked', !user);
}
async function login(){ if(!FB.auth){toastCenter("Firebase no configurado"); return;}
const email=(document.getElementById('fbEmail')?.value||"").trim(); const pass=(document.getElementById('fbPass')?.value||"").trim();
if(!email||!pass){toastCenter("Falta email/pass"); return;}
try{ await FB.auth.signInWithEmailAndPassword(email,pass); closeFbLoginModal(); }catch(e){console.warn(e); toastCenter("Login inv√°lido");}}
async function logout(){ try{ await FB.auth.signOut(); }catch(_){ } }
async function sendToDenupol(){
  if(!FB.db){ toastCenter("Firebase no configurado"); return; }
  const u = FB.auth.currentUser;
  if(!u){ toastCenter("Sin sesi√≥n"); openFbLoginModal(); return; }

  // Construir payload en claro (como hasta ahora)
  const plain = payload();

  // Pedir contrase√±a y cifrar en formato COMPAPOL
  const pass = await askPassphraseForSave();
  if (!pass){ toastCenter("Cancelado"); return; }

  let b64;
  try{
    b64 = await encryptJSON(plain, pass); // base64( salt[16] + iv[12] + ciphertext )
  }catch(e){
    console.warn(e);
    toastCenter("Error cifrando");
    return;
  }

  // Wrapper COMPAPOL (sin metadatos extra dentro)
  const compapol = {
    alg: "AES-GCM",
    kdf: "PBKDF2-SHA256",
    it: 200000,
    __compapol_enc_v1: String(b64 || "")
  };

  // Guardar en inbox: wrapper + tracking m√≠nimo
  const docOut = {
    uid: u.uid,
    email: u.email || "",
    source: "Labejar",
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: new Date().toISOString(),
    ...compapol
  };

  try{
    await FB.db.collection(DENUPOL_COLLECTION).add(docOut);
    toastCenter("‚ö°Ô∏è Enviado a GTD");
  }catch(e){
    console.warn(e);
    toastCenter("Error enviando");
  }
}
function openFbLoginModal(){const m=document.getElementById('fbLoginModal'); if(!m)return; m.classList.add('open'); m.setAttribute('aria-hidden','false'); setTimeout(()=>document.getElementById('fbEmail')?.focus(),0);}
function closeFbLoginModal(){const m=document.getElementById('fbLoginModal'); if(!m)return; m.classList.remove('open'); m.setAttribute('aria-hidden','true');}
window.addEventListener('DOMContentLoaded', ()=>{
  // Start locked by default
  document.body.classList.add('locked');

  const ok = initFirebase();
  const lockErr = document.getElementById('lockErr');
  if (!ok && lockErr){
    lockErr.style.display = '';
    lockErr.textContent = 'Firebase no configurado.';
  }

  document.getElementById('fbLoginBtn')?.addEventListener('click', ()=> ok?openFbLoginModal():toastCenter("Firebase no configurado"));
 document.getElementById('fbLogoutBtn')?.addEventListener('click', logout);
document.getElementById('btnLogoutServicios')?.addEventListener('click', logout);
  document.getElementById('fbLoginDo')?.addEventListener('click', login);
  document.getElementById('fbLoginCancel')?.addEventListener('click', closeFbLoginModal);
  document.getElementById('sendDenupolBtn')?.addEventListener('click', sendToDenupol);
  document.getElementById('fbLoginModal')?.addEventListener('click',(e)=>{ if(e.target?.id==='fbLoginModal') closeFbLoginModal();});

  ok ? FB.auth.onAuthStateChanged(ui) : ui(null);
});
</script>
<script>
// UI / wiring (moved out of parser.js on purpose)
function enforceCanonicalNacionalidad(){
  const el = document.getElementById('Nacionalidad');
  if (!el || !el.value) return;
  const raw0 = el.value.toString().trim();
  if (!raw0) return;
  const isoHit = iso3ToPaisName(raw0);
  const raw = isoHit || raw0;
  const canon = canonPais(raw);
  if (canon){
    el.value = String(canon).toUpperCase();
  } else {
    // Si no hay canon, aun as√≠ normaliza a may√∫sculas
    el.value = String(raw0).toUpperCase();
  }
}
function enforceCanonicalLugarYDomicilio(){
const hasProv = (__CANON.provMap && __CANON.provMap.size);
const hasMuni = (__CANON.muniGlobal && __CANON.muniGlobal.size);
if (!hasProv && !hasMuni) return;
const lugarEl = document.getElementById('Lugar');
const natEl = document.getElementById('Nacionalidad');
const natRaw0 = (natEl && natEl.value) ? natEl.value.toString().trim() : "";
const natIso  = iso3ToPaisName(natRaw0);
const natCanon = canonPais(natIso || natRaw0);
const natCanonNorm = _normKey(natCanon);
const espNorm = _normKey(canonPais('ESPA√ëA') || 'ESPA√ëA');
const natIsSpain = !!natCanon && (natCanonNorm === espNorm);
if (lugarEl && (!lugarEl.value || !lugarEl.value.toString().trim())){
if (natCanon && !natIsSpain){
lugarEl.value = `${tcase(natCanon)}`;
}
}
if (lugarEl && lugarEl.value){
const raw = lugarEl.value.toString().trim();
if (natCanon && !natIsSpain){
const parts2 = raw.split(',').map(s=>s.trim()).filter(Boolean);
const lastTok = parts2.length ? parts2[parts2.length-1] : raw;
const isoHit = iso3ToPaisName(lastTok) || iso3ToPaisName(raw);
const paisTry = canonPais(isoHit || lastTok) || canonPais(raw);
const finalPais = (paisTry && _normKey(paisTry) !== natCanonNorm) ? paisTry : natCanon;
lugarEl.value = `${tcase(finalPais)}`;
} else {
const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
let munRaw = "", provRaw = "";
if (parts.length >= 2){
provRaw = parts[parts.length-1];
munRaw  = parts.slice(0, parts.length-1).join(', ');
} else if (parts.length === 1){
const p = canonProvincia(parts[0]);
if (p) provRaw = parts[0];
else munRaw = parts[0];
}
const provCanon = provRaw ? canonProvincia(provRaw) : "";
const munCanon  = munRaw ? canonMunicipio(munRaw, provCanon) : "";
if (provCanon && munCanon){
lugarEl.value = `${tcase(munCanon)}, ${tcase(provCanon)}`;
} else if (provCanon && !munCanon){
lugarEl.value = `${tcase(provCanon)}`;
} else if (!provCanon && munCanon){
lugarEl.value = `${tcase(munCanon)}`;
} else {
const parts2 = raw.split(',').map(s=>s.trim()).filter(Boolean);
const lastTok = parts2.length ? parts2[parts2.length-1] : raw;
const isoHit = iso3ToPaisName(lastTok) || iso3ToPaisName(raw);
const paisTry = canonPais(isoHit || lastTok) || canonPais(raw);
const finalPais = paisTry || natCanon;
if (finalPais){
lugarEl.value = `${tcase(finalPais)}`;
}
}
}
}
const domEl = document.getElementById('Domicilio');
if (domEl && domEl.value){
const raw = domEl.value.toString().trim();
const parts = raw.split(',').map(s=>s.trim()).filter(Boolean);
if (parts.length >= 2){
const provRaw = parts[parts.length-1];
const munRaw  = parts[parts.length-2];
const provCanon = canonProvincia(provRaw);
const munCanon  = canonMunicipio(munRaw, provCanon);
if (provCanon || munCanon){
const newParts = parts.slice(0, -2);
newParts.push(munCanon ? tcase(munCanon) : tcase(munRaw));
newParts.push(provCanon ? tcase(provCanon) : tcase(provRaw));
domEl.value = newParts.join(', ');
}
}
}
}
function validateField(el, force=false){
if (!el) return;
const value = (el.value || "").trim();
let ok = false;
if (el.tagName === "INPUT" || el.tagName === "TEXTAREA"){
ok = value.length >= 2;
} else if (el.tagName === "SELECT"){
ok = value !== "";
}
const touched = el.dataset.touched === "1";
if (!force && !touched && !value){
el.classList.remove("valid","invalid");
return;
}
el.classList.toggle("valid", ok);
el.classList.toggle("invalid", !ok);
}
function validateAll(){
["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
.forEach(id=>{
const el = document.getElementById(id);
if (!el) return;
validateField(el);
});
}
function updateCount(){
renderLista();
}

// Persistencia local SOLO de filiaciones (NO doc, NO servicios)
const FILI_LS_KEY = 'LABEJAR_FILIACIONES_V1';
function saveFiliaciones(){
  try{ localStorage.setItem(FILI_LS_KEY, JSON.stringify(expediente.filiaciones || [])); }catch(_){/* noop */}
}
function loadFiliaciones(){
  try{
    const raw = localStorage.getItem(FILI_LS_KEY);
    if (!raw) return;
    const arr = JSON.parse(raw);
    if (Array.isArray(arr)) expediente.filiaciones = arr;
  }catch(_){/* noop */}
}

function renderLista(){
const ul = document.getElementById('listaF');
ul.innerHTML = "";
expediente.filiaciones.forEach((f,i)=>{
const li = document.createElement('li');
const label = `${i+1}. ${f.Apellidos || '(sin apellidos)'}${f.Nombre ? ', '+f.Nombre : ''}`;
li.textContent = label;
const btn = document.createElement('button');
btn.className = "btn secondary";
btn.textContent = "Editar";
btn.onclick = ()=> {
fillFormFromParsed(f);
["Telefono","Condicion"].forEach(id=>{
const el=document.getElementById(id);
if (id==="Telefono" && f["Tel√©fono"]!=null) el.value = f["Tel√©fono"];
if (id==="Condicion" && f["Condici√≥n"]!=null) el.value = f["Condici√≥n"];
});
    expediente.filiaciones.splice(i,1);
    saveFiliaciones();
    updateCount();
};
li.appendChild(btn);
ul.appendChild(li);
});
}
function getFormAsFiliacion(){
return {
"Nombre": document.getElementById('Nombre').value,
"Apellidos": (document.getElementById('Apellidos').value||"").toUpperCase(),
"Tipo de documento": document.getElementById('Tipo').value,
"N¬∫ Documento": document.getElementById('Numero').value,
"Sexo": document.getElementById('Sexo').value,
"Nacionalidad": document.getElementById('Nacionalidad').value,
"Nombre de los Padres": document.getElementById('Padres').value,
"Fecha de nacimiento": document.getElementById('Nacimiento').value,
"Lugar de nacimiento": document.getElementById('Lugar').value,
"Domicilio": document.getElementById('Domicilio').value,
"Tel√©fono": document.getElementById('Telefono').value,
"Condici√≥n": document.getElementById('Condicion').value
};
}
function fillFormFromParsed(p){
  (function(){
    const n0 = (p && p.Nombre != null) ? String(p.Nombre).trim() : "";
    const a0 = (p && p.Apellidos != null) ? String(p.Apellidos).trim() : "";
    const split2 = (s) => String(s || "").trim().split(/\s+/).filter(Boolean);
    if (!n0 && a0) {
      const toks = split2(a0);
      if (toks.length === 2) {
        p.Nombre = tcase(toks[0]);
        p.Apellidos = String(toks[1]).toUpperCase();
      }
    }
    if (!a0 && n0) {
      const toks = split2(n0);
      if (toks.length === 2) {
        p.Nombre = tcase(toks[0]);
        p.Apellidos = String(toks[1]).toUpperCase();
      }
    }
  })();
  if(p.Nombre!=null)  document.getElementById('Nombre').value = p.Nombre;
  if(p.Apellidos!=null) document.getElementById('Apellidos').value = p.Apellidos;
  if(p["Tipo de documento"]!=null) document.getElementById('Tipo').value = p["Tipo de documento"];
  if(p["N¬∫ Documento"]!=null) document.getElementById('Numero').value = p["N¬∫ Documento"];
  if(p.Sexo!=null) document.getElementById('Sexo').value = p.Sexo;
  if(p.Nacionalidad!=null) document.getElementById('Nacionalidad').value = String(p.Nacionalidad).toUpperCase();
  if (natElFix && /^espa√±a$/i.test(natElFix.value.trim())) natElFix.value='Espa√±a';
  if(p["Nombre de los Padres"]!=null) document.getElementById('Padres').value = p["Nombre de los Padres"];
  if(p["Fecha de nacimiento"]!=null) document.getElementById('Nacimiento').value = p["Fecha de nacimiento"];
  if(p["Lugar de nacimiento"]!=null) document.getElementById('Lugar').value = p["Lugar de nacimiento"];
  if(p.Domicilio!=null) document.getElementById('Domicilio').value = p.Domicilio;
  for (const id of ['Nombre','Apellidos','Padres','Lugar','Domicilio','Numero']){
    document.getElementById(id)?.classList.remove('uncertain');
  }
  if (p._flags){
    if (p._flags.Nombre) document.getElementById('Nombre')?.classList.add('uncertain');
    if (p._flags.Apellidos) document.getElementById('Apellidos')?.classList.add('uncertain');
    if (p._flags.Padres) document.getElementById('Padres')?.classList.add('uncertain');
    if (p._flags.Lugar) document.getElementById('Lugar')?.classList.add('uncertain');
    if (p._flags.Domicilio) document.getElementById('Domicilio')?.classList.add('uncertain');
    if (p._flags.Numero) document.getElementById('Numero')?.classList.add('uncertain');
  }
  enforceCanonicalNacionalidad();
  enforceCanonicalLugarYDomicilio();
  validateAll();
}
function clearFormFieldsOnly(){
  ["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"]
  .forEach(id=>{
    const el=document.getElementById(id);
    if (el){
      el.value="";
      el.classList.remove('uncertain','valid','invalid');
      el.dataset.touched = "0";
    }
  });

    const ta = document.getElementById('Doc');
  if (ta){
    ta.value = "";
  }
  if (typeof expediente === 'object' && expediente) expediente.doc = "";
}

function clearFormOnly(){
  clearFormFieldsOnly();
  // Vaciar tambi√©n las filiaciones agregadas
  expediente.filiaciones = [];
  updateCount();
  try{ localStorage.removeItem(FILI_LS_KEY); }catch(_){/* noop */}
}


document.getElementById('addFiliacion').addEventListener('click', ()=>{
const f = getFormAsFiliacion();
const anyVal = Object.values(f).some(v => (v||"").trim()!=="");
if (!anyVal){ alert("Ficha vac√≠a."); return; }
const condEl = document.getElementById('Condicion');
const cond = (condEl.value || "").trim();
if (!cond){
alert("Selecciona la Condici√≥n (obligatoria) antes de agregar la filiaci√≥n.");
condEl.focus();
condEl.classList.add('invalid');
return;
} else {
condEl.classList.remove('invalid');
condEl.classList.add('valid');
}
expediente.filiaciones.push(f);
saveFiliaciones();
updateCount();
clearFormFieldsOnly();
});
const __bee = document.getElementById('btnClearFromHeader');
let __screen = 1; // 1=filiacion, 2=comparecencia, 3=servicios
let __pressT = null;

function setScreen(n){
  __screen = n;
  const s1 = document.getElementById('screenFiliacion');
  const s2 = document.getElementById('screenComparecencia');
  const s3 = document.getElementById('screenServicios');
  if (s1) s1.style.display = (n===1) ? '' : 'none';
  if (s2) s2.style.display = (n===2) ? '' : 'none';
  if (s3) s3.style.display = (n===3) ? '' : 'none';

  // Ocultar botones de OCR fuera de Filiaci√≥n
  const ocrRow = document.getElementById('readAnalyzeFile')?.closest('.span2');
  if (ocrRow) ocrRow.style.display = (n===1) ? '' : 'none';

  if (__bee){
    __bee.title = (n===1) ? 'Filiaci√≥n' : (n===2) ? 'Comparecencia' : 'Servicios';
  }

  const sub = document.getElementById('subtitleText');
  if (sub){
    sub.textContent = (n===1)
      ? 'Filiaciones'
      : (n===2)
        ? 'Comparecencia'
        : 'Servicios';
  }


  try{ sessionStorage.setItem('LABEJAR_SCREEN', String(n)); }catch(_){}

  // estado pantalla para logout flotante (CSS por clases)
  const authed = !!(FB && FB.auth && FB.auth.currentUser);
  document.body.classList.toggle('fbAuthed', authed);
  document.body.classList.toggle('inServicios', authed && n === 3);
}

function nextScreen(){
  setScreen(__screen === 3 ? 1 : (__screen + 1));
}

if (__bee){
  // click corto: ciclo de pantallas
  __bee.addEventListener('click', ()=>{
    if (__bee.dataset.lp === '1'){ __bee.dataset.lp = '0'; return; }
    nextScreen();
  });

  // pulsaci√≥n larga: borrar expediente (NO servicios)
  const startLP = ()=>{
    clearTimeout(__pressT);
    __pressT = setTimeout(()=>{
      __bee.dataset.lp = '1';
      clearFormOnly();
      alert('Borrado: expediente (filiaciones + doc).');
    }, 850);
  };
  const endLP = ()=>{ clearTimeout(__pressT); __pressT = null; };

  __bee.addEventListener('mousedown', startLP);
  __bee.addEventListener('touchstart', startLP, { passive:true });
  __bee.addEventListener('mouseup', endLP);
  __bee.addEventListener('mouseleave', endLP);
  __bee.addEventListener('touchend', endLP);
}

// restaurar √∫ltima pantalla
try{
  const saved = parseInt(sessionStorage.getItem('LABEJAR_SCREEN')||'1',10);
  if ([1,2,3].includes(saved)) __screen = saved;
}catch(_){}
setScreen(__screen);
const natElFix = document.getElementById('Nacionalidad');
const natDL = document.getElementById('dlNacionalidad');

function updateNatSuggestions(){
  if (!natElFix || !natDL) return;
  const q = (natElFix.value || '').trim();
  if (q.length < 3){ natDL.innerHTML = ''; return; }
  const P = window.PAISES;
  const list = [];
  if (P){
    if (Array.isArray(P)){
      list.push(...P);
    } else {
      if (Array.isArray(P.featured)) list.push(...P.featured);
      if (Array.isArray(P.groups)){
        for (const g of P.groups){
          if (g && Array.isArray(g.items)) list.push(...g.items);
        }
      }
    }
  }
  const qn = _normKey(q);
  const hits = [];
  for (const raw of list){
    const name = String(canonPais(String(raw)) || String(raw)).toUpperCase();
    if (_normKey(name).includes(qn)) hits.push(name);
    if (hits.length >= 25) break;
  }
  natDL.innerHTML = hits.map(v => `<option value="${v}"></option>`).join('');
}

if (natElFix){
  const fix = ()=>{
    if (!natElFix.value) return;
    // forzar siempre may√∫sculas
    natElFix.value = natElFix.value.toUpperCase();
    enforceCanonicalNacionalidad();
  };
  natElFix.addEventListener('input', ()=>{
    natElFix.value = natElFix.value.toUpperCase();
    updateNatSuggestions();
  });
  natElFix.addEventListener('change', ()=>{ fix(); updateNatSuggestions(); });
  natElFix.addEventListener('blur', fix);
}
const btnDownload = document.getElementById('download');

// === AES-GCM (compat CompaSC loadEncrypted): base64( salt[16] + iv[12] + ciphertext ) ===
const __enc = new TextEncoder();
const __dec = new TextDecoder();
function bufToB64(buf){ const bytes=new Uint8Array(buf); let bin=""; for(let i=0;i<bytes.length;i++) bin+=String.fromCharCode(bytes[i]); return btoa(bin); }
function b64ToBuf(b64){ const bin=atob((b64||"").trim()); const len=bin.length; const bytes=new Uint8Array(len); for(let i=0;i<len;i++) bytes[i]=bin.charCodeAt(i); return bytes.buffer; }
function concatBytes(a,b,c){
  const al=a.length, bl=b.length, cl=c.length;
  const out=new Uint8Array(al+bl+cl);
  out.set(a,0); out.set(b,al); out.set(c,al+bl);
  return out;
}
async function deriveKeyFromPassphraseEncrypt(pass, salt){
  const baseKey=await crypto.subtle.importKey("raw", __enc.encode(pass),"PBKDF2",false,["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name:"PBKDF2",salt,iterations:200000,hash:"SHA-256"},
    baseKey,
    {name:"AES-GCM",length:256},
    false,
    ["encrypt"]
  );
}
async function encryptJSON(obj, passphrase){
  const salt=crypto.getRandomValues(new Uint8Array(16));
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKeyFromPassphraseEncrypt(passphrase, salt);
  const plain=__enc.encode(JSON.stringify(obj));
  const cipher=await crypto.subtle.encrypt({name:"AES-GCM",iv}, key, plain);
  const packed=concatBytes(salt, iv, new Uint8Array(cipher));
  return bufToB64(packed.buffer);
}

const FIXED_COMPAPOL_PASSWORD = "adejegtd";
// === Password modal + optional OS password manager integration ===
const PASS_CRED_ID = "compasc";
let __lastPass = "";

async function tryGetSavedPassword(){
  try{
    if (!navigator.credentials || !navigator.credentials.get) return "";
    const cred = await navigator.credentials.get({ password:true, mediation:"optional" });
    if (cred && cred.password) return String(cred.password);
  }catch(_){ }
  return "";
}

async function storePasswordWithOS(pass){
  try{
    if (!navigator.credentials || !navigator.credentials.store || !window.PasswordCredential) return false;
    const fd = new FormData();
    fd.set('id', PASS_CRED_ID);
    fd.set('name', 'Compasc');
    fd.set('password', pass);
    const cred = new PasswordCredential(fd);
    await navigator.credentials.store(cred);
    return true;
  }catch(_){ return false; }
}

function openPassModal(){
  const modal = document.getElementById('passModal');
  if (!modal) return;
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
  const inp = document.getElementById('passInput');
  const chk = document.getElementById('passRemember');
  if (inp) inp.value = __lastPass || '';
  if (chk) chk.checked = true;
  setTimeout(()=>{ inp?.focus(); }, 0);
}
function closePassModal(){
  const modal = document.getElementById('passModal');
  if (!modal) return;
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden','true');
}

async function askPassphraseForSave(){
  return FIXED_COMPAPOL_PASSWORD;
}

if (btnDownload){
  btnDownload.addEventListener('click', async ()=>{
  if (__screen === 1){
    const f = getFormAsFiliacion();
    const anyVal = Object.values(f).some(v => (v||"").trim()!=="");
    if (anyVal){
      alert(
        "Tienes datos en la ficha de filiaci√≥n que no has agregado al expediente.\n\n" +
        "Pulsa 'Agregar filiaci√≥n' o limpia la ficha antes de continuar."
      );
      return;
    }
  }

  expediente.doc = document.getElementById('Doc').value || expediente.doc || "";

  const data = {
    doc: expediente.doc,
    filiaciones: expediente.filiaciones
  };

  try{
    // === cifrado COMPAPOL ===
    const b64 = await encryptJSON(data, FIXED_COMPAPOL_PASSWORD);

    const d = new Date();
    const pad = n => String(n).padStart(2,'0');

    const fecha = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)}`;
    const hora  = `${pad(d.getHours())}:${pad(d.getMinutes())}`;

    const titulo = `üì• Comparecencia Zeta ¬∑ ${fecha} ¬∑ ${hora}h`;
    const filename =
  `Compa ${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}h${pad(d.getMinutes())}.enc`;
    const blob = new Blob([b64], { type: "application/octet-stream" });
    const file = new File([blob], filename, {
      type: "application/octet-stream"
    });

    // === compartir (iOS / m√≥vil / WhatsApp / Mail) ===
    if (navigator.share){
      try{
        await navigator.share({
          title: titulo,
          text: titulo,
          files: [file]
        });
        toastCenter("Compartido");
        return;
      }catch(_){
        // en macOS suele fallar ‚Üí seguimos a descarga
      }
    }

    // === fallback universal: descarga ===
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 800);

    toastCenter("Descargado");

  }catch(err){
    console.error("Error exportando:", err);
    alert("No se pudo generar el archivo cifrado.");
  }
});
}
["Nombre","Apellidos","Tipo","Numero","Sexo","Nacionalidad","Padres","Nacimiento","Lugar","Domicilio","Telefono","Condicion"].forEach(id => {
const el = document.getElementById(id);
if (!el) return;
const markTouchedAndValidate = (force=false)=>{
el.dataset.touched = "1";
validateField(el, force);
};
el.addEventListener("blur", () => markTouchedAndValidate(true));
if (el.tagName === "SELECT"){
el.addEventListener("change", () => markTouchedAndValidate(true));
}
});
// Formato autom√°tico dd/mm/aaaa (solo n√∫meros)
const nac = document.getElementById('Nacimiento');
if (nac){
  nac.addEventListener('input', ()=>{
    let v = nac.value.replace(/\D/g,'').slice(0,8);
    if (v.length > 4) v = v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
    else if (v.length > 2) v = v.slice(0,2)+'/'+v.slice(2);
    nac.value = v;
  });
}
loadFiliaciones();
updateCount();
validateAll();
initMunicipios();
initNombres();
</script>
<script>
let OCR_API_URL_DEFAULT = "https://ocr-vision-1054102077894.europe-west1.run.app";
let OCR_API_URL = OCR_API_URL_DEFAULT;
const AUTH_LS_KEY = "DECLARATRON_AUTH_V1";
let AUTH = { group:"", pass:"", apiUrl:"" };
function loadAuth(){
try{
const raw = localStorage.getItem(AUTH_LS_KEY);
if (!raw) return;
const obj = JSON.parse(raw);
if (obj && typeof obj === 'object'){
AUTH.group = String(obj.group||'').trim();
AUTH.pass  = String(obj.pass||'').trim();
AUTH.apiUrl= String(obj.apiUrl||'').trim();
if (AUTH.apiUrl) OCR_API_URL = AUTH.apiUrl;
}
}catch(_){/* noop */}
}
function saveAuth(){
localStorage.setItem(AUTH_LS_KEY, JSON.stringify(AUTH));
}
function clearAuth(){
localStorage.removeItem(AUTH_LS_KEY);
AUTH = { group:"", pass:"", apiUrl:"" };
OCR_API_URL = OCR_API_URL_DEFAULT;
}
function authHeaders(){
const h = {};
if (AUTH.group) h["x-group"] = AUTH.group;
if (AUTH.pass)  h["x-group-pass"] = AUTH.pass;
return h;
}

// Nueva funci√≥n: validar credenciales contra backend
async function authCheckNow(showAlert=true){
  try{
    const base = (OCR_API_URL || OCR_API_URL_DEFAULT || '').replace(/\/+$/,'');
    const r = await fetch(base + '/auth-check', {
      method: 'GET',
      headers: authHeaders()
    });
    const txt = await r.text();
    if (!r.ok) throw new Error(txt);
    return true;
  }catch(e){
    if (showAlert) alert('Acceso no v√°lido: ' + String(e?.message || e));
    return false;
  }
}
function updateAuthUI(){
  const btnAuth = document.getElementById('btnAuth');
  const btnLogout = document.getElementById('btnLogout');
  const ok = !!(AUTH.group && AUTH.pass);

  if (btnAuth)   btnAuth.style.display = ok ? 'none' : '';
  if (btnLogout) btnLogout.style.display = ok ? '' : 'none';
}
function openAuthModal(){
const modal = document.getElementById('authModal');
if (!modal) return;
modal.classList.add('open');
modal.setAttribute('aria-hidden','false');
const g = document.getElementById('authGroup');
const p = document.getElementById('authPass');
const u = document.getElementById('authApiUrl');
if (g) g.value = AUTH.group || '';
if (p) p.value = AUTH.pass  || '';
if (u) u.value = (AUTH.apiUrl || OCR_API_URL_DEFAULT);
setTimeout(()=>{ g?.focus(); }, 0);
}
function closeAuthModal(){
const modal = document.getElementById('authModal');
if (!modal) return;
modal.classList.remove('open');
modal.setAttribute('aria-hidden','true');
}
function wireAuthUI(){
document.getElementById('btnAuth')?.addEventListener('click', openAuthModal);
document.getElementById('btnLogout')?.addEventListener('click', ()=>{
clearAuth();
updateAuthUI();
alert('Acceso borrado.');
});
document.getElementById('authCancel')?.addEventListener('click', closeAuthModal);
document.getElementById('authModal')?.addEventListener('click', (e)=>{
if (e.target && e.target.id === 'authModal') closeAuthModal();
});
document.getElementById('authSave')?.addEventListener('click', async ()=>{
  const g = (document.getElementById('authGroup')?.value || '').trim();
  const p = (document.getElementById('authPass')?.value  || '').trim();
  const u = (document.getElementById('authApiUrl')?.value|| '').trim();

  // aplicar provisionalmente
  const prev = { ...AUTH };
  const prevUrl = OCR_API_URL;

  AUTH.group = g;
  AUTH.pass  = p;
  AUTH.apiUrl= u;
  OCR_API_URL = AUTH.apiUrl || OCR_API_URL_DEFAULT;

  // VALIDAR CONTRA BACKEND AHORA (no en OCR)
  const ok = await authCheckNow(true);
  if (!ok){
    AUTH = prev;
    OCR_API_URL = prevUrl;
    updateAuthUI();
    return; // no cerrar modal
  }

  saveAuth();
  updateAuthUI();
  closeAuthModal();
});
}
loadAuth();
const MAX_IMAGE_BYTES = 400 * 1024;
const TARGET_LONG_EDGE = 2200;
function mapBackendToFilFields(p){
const safe = v => (v == null ? "" : String(v));
const sanitizeKeepComma = (s) => safe(s)
.replace(/[^0-9A-Za-z√Ä-√ñ√ò-√∂√∏-√ø√ë√±\s,\/\-\.]/g, '')
.replace(/\s+/g, ' ')
.trim();
const mrz2 = (p && Array.isArray(p.mrz) && p.mrz[1]) ? String(p.mrz[1]).replace(/\s+/g,'') : "";
const normSexo = (v)=>{
const s = safe(v).trim().toUpperCase();
if (!s) return "";
if (s.startsWith('F')) return 'FEMENINO';
if (s.startsWith('M')) return 'MASCULINO';
return (s === 'FEMENINO' || s === 'MASCULINO') ? s : "";
};
let sexo = normSexo(p?.final?.Sexo || p?.Sexo || p?.sexo || "");
if (!sexo && mrz2) {
const isPassport = String(p?.tipo_documento || '').toUpperCase() === 'PASAPORTE' || /^P</i.test(String((p?.mrz && p.mrz[0]) || ''));
const sexoCode = isPassport
? ((mrz2.length >= 21) ? mrz2.charAt(20).toUpperCase() : "")
: ((mrz2.length >= 8)  ? mrz2.charAt(7).toUpperCase()  : "");
sexo = (sexoCode === 'F') ? 'FEMENINO' : (sexoCode === 'M') ? 'MASCULINO' : '';
}
const lugar = (p?.lugar_nacimiento && String(p.lugar_nacimiento).trim())
? String(p.lugar_nacimiento).trim()
: [p?.lugar_nacimiento_municipio, p?.lugar_nacimiento_provincia]
.filter(Boolean)
.join(', ');
let _Nombre = sanitizeKeepComma(p?.nombre || '');
let _Apellidos = sanitizeKeepComma(p?.apellidos || '').toUpperCase();
const _Tipo = sanitizeKeepComma(p?.tipo_documento || 'DNI');
if (/\bNIE\b/i.test(_Tipo)) {
const isTreatment = (s)=>{
const t = String(s||'').trim().toUpperCase().replace(/\s+/g,'');
if (!t) return true;
const t2 = t.replace(/[^A-Z]/g,'');
return t2 === 'D' || t2 === 'DD' || t2 === 'DA' || t2 === 'DDA';
};
if ((isTreatment(_Nombre) || !_Nombre) && _Apellidos) {
const toks = _Apellidos.trim().split(/\s+/).filter(Boolean);
if (toks.length >= 4) {
_Nombre = toks.slice(0,2).join(' ');
_Apellidos = toks.slice(2).join(' ');
}
}
}
return {
Nombre: _Nombre,
Apellidos: _Apellidos,
"Tipo de documento": _Tipo,
"N¬∫ Documento": sanitizeKeepComma(p?.numero_documento || ''),
Nacionalidad: sanitizeKeepComma(p?.nacionalidad || ''),
"Fecha de nacimiento": sanitizeKeepComma(p?.fecha_nacimiento || ''),
"Lugar de nacimiento": sanitizeKeepComma(lugar),
"Nombre de los Padres": sanitizeKeepComma(safe(p?.hijos_de || '').replace(/\s*\/\s*/g, ' y ')),
Domicilio: sanitizeKeepComma(p?.domicilio || ''),
Sexo: sexo,
_flags: {}
};
}
async function handleDniImageInputChange(e){
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  // IA OFF: MRZ scanner offline (sin servidor)
  if (!(AUTH && AUTH.group && AUTH.pass)){
    // Abrir scanner UI y aplicar a tu flujo existente
    if (!window.MRZScanner || typeof MRZScanner.open !== 'function'){
      alert('MRZScanner no est√° disponible. Revisa que mrz.js se est√° cargando.');
      return;
    }
    try{ e.target.value = ""; }catch(_){}
    MRZScanner.open(file, {
      onMRZText: (mrzText) => {
        // Reutiliza tu pipeline actual (MRZ.parseMRZ si existe; si no, parseDocument)
        processOCR(mrzText);
      }
    });
    return;
  }

  // IA ON: OCR completo por backend
  try {
    const dataUrl = await fileToDataUrl(file);
    const res = await fetch(OCR_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify({ imageBase64: dataUrl })
    });
    const text = await res.text();
    if (!res.ok) throw new Error(text);
    const json = JSON.parse(text);
    if (!json || json.ok !== true || !json.parsed) throw new Error("Respuesta inv√°lida del backend");
    const mapped = mapBackendToFilFields(json.parsed || {});
    fillFormFromParsed(mapped);
  } catch (err) {
    console.error(err);
    try{
      const docEl = document.getElementById('Doc');
      if (docEl) docEl.value = "[OCR ERROR]" + String(err?.message || err);
    }catch(_){/* no-op */}
    alert("Error al procesar la imagen del DNI. Revisa consola.");
  }
}
document.getElementById('dniCameraInput')?.addEventListener('change', handleDniImageInputChange);
document.getElementById('dniFileInput')?.addEventListener('change', handleDniImageInputChange);
function fileToDataUrl(file) {
return new Promise((resolve, reject) => {
const img = new Image();
const url = URL.createObjectURL(file);
img.onload = async () => {
try {
let w = img.width;
let h = img.height;
const longEdge = Math.max(w, h);
if (longEdge > TARGET_LONG_EDGE) {
const scale = TARGET_LONG_EDGE / longEdge;
w = Math.round(w * scale);
h = Math.round(h * scale);
}
const canvas = document.createElement("canvas");
canvas.width = w;
canvas.height = h;
const ctx = canvas.getContext("2d", { alpha: false });
ctx.drawImage(img, 0, 0, w, h);
let quality = 0.9;
let dataUrl = canvas.toDataURL("image/jpeg", quality);
while (dataUrl.length * 0.75 > MAX_IMAGE_BYTES && quality > 0.5) {
quality -= 0.05;
dataUrl = canvas.toDataURL("image/jpeg", quality);
}
URL.revokeObjectURL(url);
resolve(dataUrl);
} catch (e) {
URL.revokeObjectURL(url);
reject(e);
}
};
img.onerror = (e) => {
URL.revokeObjectURL(url);
reject(e);
};
img.src = url;
});
}
window.addEventListener('DOMContentLoaded', async ()=>{
  wireAuthUI();
  updateAuthUI();
  // si hay credenciales guardadas, validarlas al cargar
  if (AUTH.group && AUTH.pass){
    const ok = await authCheckNow(false);
    if (!ok){
      clearAuth();
      updateAuthUI();
      alert('Acceso guardado inv√°lido. Reconfigura usuario/contrase√±a.');
    }
  }
});
function ensureAuthOrPrompt(){
  // IA ON: backend OCR completo
  // IA OFF: MRZScanner offline (no bloquear aqu√≠)
  return !!(AUTH.group && AUTH.pass);
}
</script>
<!-- Modal de acceso -->
<div class="modal" id="authModal" aria-hidden="true">
<div class="panel" role="dialog" aria-modal="true" aria-labelledby="authTitle">
<h2 id="authTitle">Acceso</h2>
<div class="fields2">
<div>
<label>Usuario</label>
<input id="authGroup" autocomplete="username" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<div>
<label>Contrase√±a</label>
<input id="authPass" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
</div>
<div class="span2 row center" style="margin-top:10px">
<button class="btn" id="authSave">Guardar</button>
<button class="btn secondary" id="authCancel">Cancelar</button>
</div>
</div>
</div>
</div>
<div class="modal" id="fbLoginModal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="fbLoginTitle">
    <h2 id="fbLoginTitle">Firebase ¬∑ Login</h2>
    <div class="fields2">
      <div><label>Email</label><input id="fbEmail" type="email" autocomplete="username"></div>
      <div><label>Contrase√±a</label><input id="fbPass" type="password" autocomplete="current-password"></div>
      <div class="span2 row center" style="margin-top:10px">
        <button class="btn" id="fbLoginDo">Entrar</button>
        <button class="btn secondary" id="fbLoginCancel">Cancelar</button>
      </div>
      <div class="span2 row center" style="margin-top:10px">
      
      </div>
    </div>
  </div>
</div>
<script src="importar.js"></script>
<script>
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/Labejar/sw.js');
</script>
<div id="toastCenter"></div>
</body>
</html>
